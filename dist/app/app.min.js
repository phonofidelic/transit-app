angular.module("transitApp",["ngRoute","ngAnimate"]),angular.module("transitApp").config(["$routeProvider","$locationProvider",function(t,o){t.when("/",{templateUrl:"app/templates/planTrip.html",controller:"PlanTripController",controllerAs:"vm"}),o.html5Mode(!0)}]),angular.module("transitApp").factory("GTFSParserService",["$http",function(t){function o(){}return o.prototype.requestData=function(o){return t({method:"GET",url:o}).then(function(t){console.log("response: ",t);var o=t.data.split("\n");return cols=[],o.forEach(function(t){cols.push(t.split(","))}),cols})["catch"](function(t){console.log("transitData error: ",t)})},o.prototype.toArrays=function(t){var o=t.split("\n"),e=[];return o.forEach(function(t){e.push(t.split(","))}),e},o.prototype.toJSON=function(t){for(var o=[],e=0,n=1;n<t.length;n++){var r={};o.push(r)}var a=[],i=t.slice(1);return i.forEach(function(t){for(var o=0;o<t.length;o++)a.push(t[o])}),o.forEach(function(o){t[0].forEach(function(t){var r=t;angular.isUndefined(a[e])&&(a[n]=""),o[r]=a[e],e++})}),o},o.prototype.groupBy=function(t,o){var e={};return t.forEach(function(t){var n=JSON.stringify(o(t));e[n]=e[n]||[],e[n].push(t)}),console.log("groups: ",e),Object.keys(e).map(function(t){return e[t]})},o.prototype.readZip=function(t,o){var e=new JSZip;return JSZipUtils.getBinaryContent(t,function(t,n){if(t)throw console.log("JSZip error: "),t;e.loadAsync(n).then(function(t){return console.log("success!: ",t),e.file(o).async("string")}).then(function(t){return t})["catch"](function(t){console.error("readZip error: ",t)})})},o}]),angular.module("transitApp").factory("LocationService",["$http",function(t){function o(){}var e=new google.maps.Geocoder;return o.prototype.getCurrentPosition=function(t,o,e){return new Promise(function(t,o){navigator.geolocation.getCurrentPosition(t,o,e)})},o.prototype.revGeocode=function(t){var o={};return o.lat=t.latitude,o.lng=t.longitude,new Promise(function(t,n){e.geocode({location:o},function(o,e){"OK"===e?t(o[0]):n(console.log("geocoding error: ",e))})})},o}]),angular.module("transitApp").factory("TransitLandRequestService",["$http",function(t){function o(){}return o.prototype.routesByOperator=function(o){var e={region:o},n="https://transit.land/api/v1/routes?operated_by="+e.region;return t({method:"GET",url:n,eventHandlers:{progress:function(t){console.log("progress: ",t)}}}).then(function(t){return t})["catch"](function(t){console.log("transitland error: ",t)})},o.prototype.routeByOnestopId=function(o){var e="https://transit.land/api/v1/routes?onestop_id="+o;return t({method:"GET",url:e,eventHandlers:{progress:function(t){console.log("progress: ",t)}}}).then(function(t){return t})["catch"](function(t){console.log("transitland error: ",t)})},o.prototype.routesByBbox=function(o){return new Promise(function(e){var n=o.lat+.05,r=o.lon-.05,a=o.lat-.05,i=o.lon+.05,s="https://transit.land/api/v1/routes?bbox="+r+","+n+","+i+","+a;return t.get(s).then(function(t){console.log("bbox response: ",t),e(t.data)})})},o.prototype.getStopInfo=function(o){var e="http://transit.land/api/v1/stops?onestop_id="+o;return t({method:"GET",url:e}).then(function(t){return console.log("getStopInfo response: ",t),t})["catch"](function(t){console.log("getStopInfo error: ",t)})},o.prototype.routeBetween=function(o,e){return t({method:"GET",url:"http://transit.land/api/v1/stops?onestop_id="+o}).then(function(t){var o={origin:t.data.stops[0]};return o}).then(function(o){return t({method:"GET",url:"http://transit.land/api/v1/stops?onestop_id="+e}).then(function(t){return o.destination=t.data.stops[0],o}).then(function(o){console.log("endpoints: ",o),console.log("endpoints.origin: ",o.origin),console.log("endpoints.destination: ",o.destination);var e={locations:[{lat:o.origin.geometry.coordinates[1],lon:o.origin.geometry.coordinates[0],type:"break"},{lat:o.destination.geometry.coordinates[1],lon:o.destination.geometry.coordinates[0],type:"break"}],costing:"multimodal"},n=(JSON.stringify(e),"https://valhalla.mapzen.com/route?json="+JSON.stringify(e)+"&api_key=valhalla-m9bds2x".replace("%22",""));console.log("mapzenUrl: ",n),t({method:"GET",url:n}).then(function(t){return console.log("routeBetween response: ",t),t})["catch"](function(t){console.log("routeBetween error: ",t)})}),o})},o.prototype.scheduleStopPairs=function(o){return t.get("http://transit.land/api/v1/schedule_stop_pairs?origin_onestop_id="+o).then(function(t){return console.log("schedule_stop_pair response: ",t),t.data.schedule_stop_pairs})["catch"](function(t){console.log("schedule_stop_pair error: ",t)})},o.prototype.routeStopPattern=function(o){return t({method:"GET",url:"http://transit.land/api/v1/route_stop_patterns?onestop_id="+o}).then(function(t){console.log("from routeStopPattern: "),console.log(t);var o=[];return t.data.route_stop_patterns[0].stop_pattern.forEach(function(t){o.push(t)}),o})["catch"](function(t){console.log("routeStopPattern error: ",t)})},o}]),angular.module("transitApp").controller("MapController",["$scope","$log","LocationService","GTFSParserService",function(t,o,e,n){var r=this,a=L.map("map",{scrollWheelZoom:!1}),i=new e,s=new n;r.stops={},r.init=function(){var t=Tangram.leafletLayer({scene:"https://raw.githubusercontent.com/tangrams/refill-style-more-labels/gh-pages/refill-style-more-labels.yaml",attribution:'<a href="https://mapzen.com/tangram" target="_blank">Tangram</a> | <a href="http://www.openstreetmap.org/about" target="_blank">&copy; OSM contributors | <a href="https://mapzen.com/" target="_blank">Mapzen</a>'});t.addTo(a),i.getCurrentPosition().then(function(t){a.setView([t.coords.latitude,t.coords.longitude],14)})["catch"](function(t){console.log("getPosition error: ",t)});var e=(L.control.geocoder("search-3LVgAzp").addTo(a),L.control.locate({position:"topleft",keepCurrentZoomLevel:!0}).addTo(a));return e.start(),o.log("init map"),a},setStopMArkers=function(){var t="http://localhost:3000/assets/transitData/stops.txt";s.requestData(t).then(function(t){console.log("GTFSParserService response: ",t);for(var o=[],e=[],n=1;n<t.length-1;n++){var r={},e=L.latLng(t[n][4],t[n][5]);r.lat=t[n][4],r.lon=t[n][5],o.push(e)}return console.log("stop coords: ",o),o}).then(function(t){t.forEach(function(t){L.marker([t.lat,t.lng]).addTo(a)});var o=L.polyline(t,{color:"red"}).addTo(a);a.fitBounds(o.getBounds())})["catch"](function(t){console.log("marker error: ",t)})},r.setRoute=function(t){i.getCurrentPosition().then(function(t){return console.log("getPosition result: ",t),t.coords}).then(function(t){return L.Routing.control({waypoints:[L.latLng(t.latitude,t.longitude),L.latLng(33.8128,-117.9259)],router:L.Routing.mapzen("valhalla-m9bds2x",{costing:"auto"}),formatter:new L.Routing.mapzenFormatter,summaryTemplate:'<div class="start">{name}</div><div class="info {costing}">{distance}, {time}</div>',routeWhileDragging:!1}).addTo(a)})["catch"](function(t){console.log("getPosition error: ",t)})}}]),angular.module("transitApp").directive("mapDirective",function(){return{templateUrl:"app/modules/map/map.html",controller:"MapController",controllerAs:"vmMap"}}),angular.module("transitApp").controller("PlanTripController",["$scope","$http","$log","$timeout","RequestService","LocationService","TransitLandRequestService","GTFSParserService",function(t,o,e,n,r,a,i,s){function c(){return navigator.serviceWorker?(console.log("initiating database"),idb.open("gtfsData",8,function(t){switch(t.oldVersion){case 0:var o=t.createObjectStore("stops",{keyPath:"stop_id"});o.createIndex("by-id","stop_id");case 1:var e=t.createObjectStore("trips",{keyPath:"trip_id"});e.createIndex("by-route-id","route_id");case 2:var n=t.createObjectStore("stop_times",{keyPath:"stop_id"});n.createIndex("by-id","stop_id");case 3:var r=t.createObjectStore("routes",{keyPath:"onestop_id"});r.createIndex("by-name","route_short_name")}})):Promise.resolve()}function l(){navigator.serviceWorker&&navigator.serviceWorker.register("/sw.js").then(function(t){if(console.log("serviceWorker registered!"),navigator.serviceWorker.controller){if(t.waiting)return void p(t.waiting);if(t.installing)return void u(t.installing);t.addEventListener("updatefound",function(){console.log("*** updatefound ***"),u(t.installing)});var o;navigator.serviceWorker.addEventListener("controllerchange",function(){console.log("*** controllerchange ***"),o||(console.log("*** reload ***"),window.location.reload(),o=!0)})}})["catch"](function(t){console.log("serviceWorker registration error: ",t)})}function u(t){console.log("trackInstalling"),t.addEventListener("statechange",function(){"installed"==t.state&&p(t)})}function p(t){console.log("updateReady"),g.showToast=!0,g.skipWaiting=function(){t.postMessage({action:"skipWaiting"}),location.reload(),console.log("skip, ",t)}}function d(t){var o="assets/transitData/google_transit.zip",t=t;return new Promise(function(e){JSZipUtils.getBinaryContent(o,function(o,n){if(o)throw console.log("JSZip error: "),o;v.loadAsync(n).then(function(o){return v.file(t).async("string")}).then(function(t){return m.toArrays(t)}).then(function(t){return m.toJSON(t)}).then(function(t){e(t)})["catch"](function(t){console.log("readZip error: ",t)})})})}var g=this,f=(new r,new a),h=new i,m=new s,v=new JSZip,y=L.map("map",{scrollWheelZoom:!1});g.gtfsParserService=new s,g.inputData={},g.inputData.departure={},g.inputData.departure.coords={},g.inputData.arrival={},g.inputData.arrival.coords={},g.currentPosition={},g.dbPromise=c(),g.init=function(){l()},g.deleteObjectStore=function(t){},g.transitRequest=function(t){h.routesByOperator(t).then(function(t){g.routeData=t.data.routes,console.log("transitRequest response: ",t)})},g.getStopInifo=function(){console.log("getStopInifo: "),g.routeData[0].stops_served_by_route.forEach(function(){h.getStopInfo(this.onestop_id)})},g.routeBetween=function(t,o){h.routeBetween(t,o).then(function(t){console.log("controller routeBetween response: ",t)})},g.routeRequest=function(t){h.routeByOnestopId(t).then(function(t){g.routeData=t.data.routes,console.log("routeRequest response: ",t)})},g.scheduleStopPairs=function(t){g.scheduleStopPairs&&(g.scheduleStopPairs=[]),h.scheduleStopPairs(t).then(function(t){console.log("scheduleStopPairs: ",t),g.scheduleStopPairs=t})},g.routeStopPattern=function(t){h.routeStopPattern(t).then(function(t){var e="";t.forEach(function(t){e+=t+","}),e=e.slice(0,-1),o.get("http://transit.land/api/v1/stops?onestop_id="+e+"&per_page=100").then(function(t){console.log("stops from routeStopPattern: ",t),console.log("stop names: "),t.data.stops.forEach(function(t){console.log(t.name)})})})},g.getCurrentPosition=function(){f.getCurrentPosition().then(function(t){return console.log("getPosition result: ",t.coords),g.currentPosition.lat=t.coords.latitude,g.currentPosition.lon=t.coords.longitude,t.coords}).then(function(t){f.revGeocode(t).then(function(t){console.log("region: ",t.address_components[3].short_name),g.currentPosition.addressString=t.formatted_address,g.currentPosition.countyString="o-dhw-browardcountytransit"})})},g.autoAddress=function(o){var e=document.getElementById(o),n={types:["address"]};"departure-inp"===e.id?t.departureAutocomplete=new google.maps.places.Autocomplete(e,n):t.arrivalAutocomplete=new google.maps.places.Autocomplete(e,n)},g.getAddress=function(o){"departure-inp"===o?n(function(){console.log("*** getAddress ***"),console.log("locationData: ",t.departureAutocomplete.getPlace()),t.departureAutocomplete.getPlace()&&(g.inputData.departure.name=t.departureAutocomplete.getPlace().formatted_address,g.inputData.departure.coords.lat=t.departureAutocomplete.getPlace().geometry.location.lat(),g.inputData.departure.coords.lon=t.departureAutocomplete.getPlace().geometry.location.lng())},500):n(function(){console.log("*** getAddress ***"),console.log("locationData: ",t.arrivalAutocomplete.getPlace()),t.arrivalAutocomplete.getPlace()&&(g.inputData.arrival.name=t.arrivalAutocomplete.getPlace().formatted_address,g.inputData.arrival.coords.lat=t.arrivalAutocomplete.getPlace().geometry.location.lat(),g.inputData.arrival.coords.lon=t.arrivalAutocomplete.getPlace().geometry.location.lng())},500)},g.sendRequest=function(t){var e={locations:[{lat:g.inputData.departure.coords.lat||g.currentPosition.lat,lon:g.inputData.departure.coords.lon||g.currentPosition.lon},{lat:g.inputData.arrival.coords.lat,lon:g.inputData.arrival.coords.lon}],costing:"multimodal",costing_options:{transit:{use_bus:.1,use_rail:1}},directions_options:{units:"miles"}},n="https://valhalla.mapzen.com/route?json="+JSON.stringify(e)+"&api_key=valhalla-m9bds2x".replace("%22","");o({method:"GET",url:n}).then(function(t){console.log("sendRequest response: ",t),g.tripData=t.data.trip})["catch"](function(t){console.log("RequestService.send error: ",t)})},g.initMap=function(){var o=Tangram.leafletLayer({scene:"https://raw.githubusercontent.com/tangrams/refill-style-more-labels/gh-pages/refill-style-more-labels.yaml",attribution:'<a href="https://mapzen.com/tangram" target="_blank">Tangram</a> | <a href="http://www.openstreetmap.org/about" target="_blank">&copy; OSM contributors | <a href="https://mapzen.com/" target="_blank">Mapzen</a>'});o.addTo(y),f.getCurrentPosition().then(function(t){return y.setView([t.coords.latitude,t.coords.longitude],14),t}).then(function(o){console.log("*** position: ",o);var e={lat:o.coords.latitude,lon:o.coords.longitude};h.routesByBbox(e).then(function(o){var e=o.routes.filter(function(t){if("o-dhw-browardcountytransit"===t.operated_by_onestop_id)return t});g.routes=e,t.$apply(),console.log("*** vm.routes: ",g.routes),e.forEach(function(t){var o=t.color,e=t.geometry.coordinates;e.forEach(function(t){var e=[];t.forEach(function(t){e.push(L.latLng(t[1],t[0]))});L.polyline(e,{color:"#"+o}).addTo(y)})})}).then(function(){angular.element(window).scroll(function(){var t=angular.element(".routeButtonSecond"),o=angular.element(".routeButtonFirst");o.offset().top>=t.offset().top&&o.removeClass("stuck"),angular.element(document).scrollTop()+window.innerHeight<o.offset().top+50&&o.addClass("stuck")}),d("routes.txt").then(function(t){g.dbPromise.then(function(o){if(o){var e=[];g.routes.forEach(function(o){t.forEach(function(t){o.name===t.route_short_name&&(t.onestop_id=o.onestop_id,e.push(t))})});var n=o.transaction("routes","readwrite"),r=n.objectStore("routes");return e.forEach(function(t){r.put(t)}),e}}).then(function(t){d("trips.txt").then(function(o){g.dbPromise.then(function(e){if(e){var n=[];t.forEach(function(t){o.forEach(function(o){o.route_id===t.route_id&&n.push(o)})});var r=e.transaction("trips","readwrite"),a=r.objectStore("trips");return n.forEach(function(t){a.put(t)}),n}})})})})})})["catch"](function(t){console.log("getPosition error: ",t)});var n=L.control.locate({position:"topleft",keepCurrentZoomLevel:!0}).addTo(y);return n.start(),e.log("init map"),y},g.selectRoute=function(t){console.log("route: ",t),g.dbPromise.then(function(o){if(o){var e=o.transaction("routes"),n=e.objectStore("routes");return n.get(t.onestop_id)}}).then(function(t){console.log("dbRoute: ",t),g.dbPromise.then(function(o){var e=o.transaction("trips"),n=e.objectStore("trips");return n.get(t.route_id)}).then(function(t){console.log("trips: ",t)})})},g.parseSelectedRoute=function(t){console.log("vm.selectedRoute: ",t),g.dbPromise.then(function(o){if(o)return o.transaction("routes").objectStore("routes").get(t)}).then(function(t){console.log("selected db route: ",t)})},g.routesByBbox=function(t){h.routesByBbox(t).then(function(t){var o=t.routes.filter(function(t){if("o-dhw-browardcountytransit"===t.operated_by_onestop_id)return t});g.routes=t.routes,console.log("*** vm.routes: ",g.routes),console.log("### testing ###"),o.forEach(function(t){var o=t.color,e=t.geometry.coordinates;e.forEach(function(t){var e=[];t.forEach(function(t){e.push(L.latLng(t[1],t[0]))});L.polyline(e,{color:"#"+o}).addTo(y)})})})["catch"](function(t){console.log("Routes setup errpr: ",t)})}}]),angular.module("transitApp").factory("RequestService",["$http",function(t){function o(){}return o.prototype.send=function(o){t({method:"GET",url:o}).then(function(t){return t})["catch"](function(t){console.log("RequestService.send error: ",t)})},o}]);